# 自动化运维代理程序 - 需求分析文档

## 1. 概述

本项目旨在开发一款跨平台（Windows/Linux）的自动化运维代理程序，支持通过加密通信接收指令，并在目标主机上安全地执行命令、脚本或动态生成的 Python 封装脚本。代理以管理员权限运行，但可切换至指定普通用户身份执行任务，支持离线部署与 RESTful API 调用。

---

## 2. 功能需求

### 2.1 核心功能

| 编号 | 功能名称 | 描述 |
|------|--------|------|
| FR-01 | 命令执行 | 接收远程指令并执行系统命令，返回标准输出、错误及退出码。 |
| FR-02 | 本地脚本执行 | 支持上传并执行本地脚本文件（如 .sh, .ps1, .py 等），保持原始解释器环境。 |
| FR-03 | 动态脚本转换与执行 | 接收任意类型脚本内容，自动识别类型后封装为随机命名的 Python 脚本，使用 `subprocess` 执行。 |
| FR-04 | 用户身份切换 | 支持在执行命令或脚本时切换到指定普通用户，加载其家目录、环境变量和完整登录会话。 |
| FR-05 | 离线部署模式 | 可在无外网连接环境下安装和运行，不依赖外部包管理器或配置中心。 |
| FR-06 | RESTful API 接口 | 提供标准 HTTP 接口用于任务下发、状态查询和结果获取。 |
| FR-07 | 加密通信 | 所有与控制端的通信均使用 TLSv1.2+ 协议加密，支持双向证书认证。 |

### 2.2 脚本类型识别机制

- **识别方式**：解析脚本首行 `shebang`（如 `#!/bin/bash`, `#!/usr/bin/env python`）判断类型；若无 shebang，则根据传入内容特征或扩展名提示进行推断。
- **支持类型**：
  - Shell 脚本（.sh） → 使用 `/bin/bash` 执行
  - PowerShell 脚本（.ps1）→ 使用 `powershell.exe` 执行（Windows）
  - Python 脚本（.py）→ 使用代理程序的Python 解释器执行
  - 其他脚本 → 视为 Shell 或自定义解释器调用

### 2.3 脚本封装执行逻辑（FR-03）

1. 接收原始脚本内容；
2. 自动识别脚本类型；
3. 生成一个随机文件名（如 `tmp_<random>.py`）；
4. 创建 Python 脚本，内容如下结构：
   ```python
   import subprocess
   import os
   
   script_content = """<原始脚本内容>"""
   temp_script_path = "/tmp/<random>.ext"  # 根据类型决定扩展名
   
   with open(temp_script_path, 'w') as f:
       f.write(script_content)
       os.chmod(temp_script_path, 0o755)  # 添加执行权限
   
   result = subprocess.run(["<interpreter>", temp_script_path], 
                           capture_output=True, text=True, env=os.environ)
   print(result.stdout)
   if result.returncode != 0:
       print(result.stderr, file=sys.stderr)
   sys.exit(result.returncode)
   ```
5. 执行该 Python 脚本，并返回结果。
6. 基本执行完成后自动删除随时生成的脚本。

### 2.4 用户身份切换机制（FR-04）

#### Linux 平台
- 使用 `su - <username>` 方式执行命令，确保加载目标用户的 shell 环境、家目录和 profile 配置；
- 要求系统已配置免密 sudo 权限或 su 免密策略（PAM 配置）；
- 示例命令：
  ```bash
  echo '<password>' | su - <username> -c '/path/to/command'
  ```
  > ⚠️ 当前需求为“无需密码”，故需依赖预配置的信任机制（如 wheel 组 + NOPASSWD）。

#### Windows 平台
- 使用 Windows API `CreateProcessAsUser` 或 `CreateProcessWithLogonW`；
- 调用时设置标志 `LOGON_WITH_PROFILE` 以加载用户注册表配置（HKEY_CURRENT_USER）；
- 模拟完整登录会话，包括桌面访问权限（如有需要）；
- 需要代理服务具有 `SE_INCREASE_QUOTA_NAME` 和 `SE_ASSIGNPRIMARYTOKEN_NAME` 权限。

### 2.5 RESTful API 设计（FR-06）

| 方法 | 路径 | 功能 | 请求体示例 |
|------|------|------|-----------|
| POST | `/exec/command` | 执行系统命令 | `{"command": "ls -l", "user": "alice"}` |
| POST | `/exec/script/file` | 执行上传的脚本文件 | multipart/form-data | 
| POST | `/exec/script/content` | 执行内联脚本内容 | `{"script": "#!/bin/bash\necho hello", "user": "bob"}` |
| GET  | `/status` | 获取代理运行状态 | - |

响应格式统一为 JSON：
```json
{
  "success": true,
  "output": "...",
  "error": "...",
  "return_code": 0
}
```

### 2.6 安全与加密通信（FR-07）

- 使用 HTTPS 协议提供 RESTful 服务；
- 启用 TLSv1.2 或更高版本；
- 支持服务器证书认证，可选启用客户端证书双向认证（mTLS）；
- 私钥与证书可通过配置文件指定路径加载；
- 默认端口：`8443`。

---

## 3. 非功能需求

| 编号 | 类别 | 要求 |
|------|------|------|
| NFR-01 | 跨平台支持 | 支持 Windows 10/11/Server, Linux（CentOS, Ubuntu 等主流发行版） |
| NFR-02 | 运行权限 | 以管理员/root 权限运行，具备提权能力 |
| NFR-03 | 日志记录 | 记录关键操作日志（执行命令、用户切换、错误信息），支持日志级别配置 |
| NFR-04 | 错误处理 | 对脚本执行失败、用户切换失败等情况提供详细错误信息 |
| NFR-05 | 可维护性 | 支持配置文件管理（如 cert 路径、监听地址、端口等） |
| NFR-06 | 性能要求 | 单次命令执行延迟 < 1s（本地网络） |
| NFR-07 | 安全合规 | 不明文存储凭证，临时文件执行后自动清理 |

---

## 4. 其他需求

1. 支持单向认证
2. 支持持久化任务队列（如断网重连后继续执行）
3. 支持心跳上报机制

---

> 文档版本：v1.0
> 创建时间：2025-04-05